# Implementation Plan: Home Hub Display Foundation

**Branch**: `004-bygg-grunden-till` | **Date**: 2025-09-29 | **Spec**: [specs/004-bygg-grunden-till/spec.md](specs/004-bygg-grunden-till/spec.md)  
**Input**: Feature specification from `specs/004-bygg-grunden-till/spec.md`

## Summary
Bygg en alltid-på hemmaskärm som körs i fullskärm via Electron + Nuxt 3 (Vue 3, TypeScript) med modulstöd för widgets, nederpaneler, helskärmsvyer och bakgrundsjobb. Leveransen omfattar applikationsgrunden, modul-API, layoutredigering i ett inställningsläge, säker hantering av känsliga inställningar via krypterad `electron-store`, automatisk uppdateringshantering via GitHub-releasefeed, samt färdig paketering för macOS, Windows och Raspberry Pi (32/64-bit).

## Technical Context
**Language/Version**: TypeScript 5.x, Node.js 20, Electron 28.x, Nuxt 3 (Vue 3.4)  
**Primary Dependencies**: Electron, Nuxt 3 (with Vite bundler), Vue 3 composition API, electron-store + secure encryption plugin, electron-updater (GitHub provider), electron-builder, dayjs, axios (externa datakällor), vitest + playwright, eslint/prettier  
**Storage**: `electron-store` (JSON persistence med AES-GCM krypteringsnyckel lagrad i OS-keychain)  
**Testing**: Vitest (enhet), Vue Test Utils, Playwright (touch/e2e), electron-mocha (main-process), custom hardware smoke tests på Raspberry Pi 4  
**Target Platform**: Desktop (macOS 13+, Windows 11/10) och Raspberry Pi OS (Bullseye/Bookworm, 32/64-bit)  
**Project Type**: Single desktop app (Electron shell med Nuxt renderer och modulpaket)  
**Performance Goals**: <150MB RSS, <40% CPU på Raspberry Pi 4 (2GB), <5s cold start till huvudpanel, 60 Hz touchrespons  
**Constraints**: Ingen global scroll på huvudvy, alltid fullskärm, touch-first UI, modulmanifester med begränsade rutnätsstorlekar, pollingintervall >=1 minut, offline-tåligt cache-beteende, auto-update check varje timme  
**Scale/Scope**: Ett hushåll (1–6 användare), 10–20 samtidiga widgets, 5–10 bakgrundsjobb, dagliga datauppdateringar från kalendrar/väder/APIer

## Constitution Check
*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- **Maintainable Code First**: Kodbasen struktureras i `apps/frame-boy` (Electron main + preload + renderer) och `modules/` (core plugins); inför eslint/prettier, type-safe modul-API, ADR för modularkitektur och krypteringsstrategi.  
- **Test-Driven Reliability**: Definiera Vitest/Playwright suites, skapa initiala röda tester för modulregistrering, layoutpersistens, bakgrundsjobb och krypterad lagring; CI körar mot macOS + Windows + armv7 emulator med SBC smoke script.  
- **Human-Centred Experience**: UX-spec lever av nuvarande spec; plan inkluderar touch-first design review, tillgänglighet (WCAG 2.1 AA kontrast, fontstorlek >18px), lokalt läge för att grids inte scrollar; quickstart instruktioner för hushållstest.  
- **Lean Hardware Footprint**: Profilera Nuxt-bundles (<3MB), lazy-load widgets, throttla bakgrundsjobb, metrics via `electron-store` + telemetry modul för minne/CPU; include Pi smoke test pipeline.  
- **Governance Alignment**: Ingen avvikelse kräver godkännande; eventuella framtida modul-sandbox ändringar dokumenteras i `docs/adr/0001-module-architecture.md` (Phase 0 output). 

✅ Initial Constitution Check: PASS (alla principer adresseras i planen)

## Project Structure

### Documentation (this feature)
```
specs/004-bygg-grunden-till/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
│   ├── module-manifest.md
│   ├── widget-registration.md
│   ├── background-job.md
│   └── auto-update.md
└── tasks.md   # generated by /tasks (NOT created in /plan)
```

### Source Code (repository root)
```
apps/
└── frame-boy/
    ├── package.json
    ├── electron/
    │   ├── main/
    │   │   ├── index.ts
    │   │   ├── windows/
    │   │   ├── security/
    │   │   └── updates/
    │   ├── preload/
    │   └── builders/
    ├── renderer/
    │   └── nuxt-app/
    │       ├── app/
    │       ├── components/
    │       ├── layouts/
    │       ├── pages/
    │       ├── widgets/
    │       ├── plugins/
    │       └── assets/
    ├── modules/
    │   ├── core-clock/
    │   ├── core-weather/
    │   ├── core-calendar/
    │   └── core-home-status/
    ├── shared/
    │   ├── api/
    │   ├── services/
    │   ├── stores/
    │   └── types/
    ├── scripts/
    └── tests/
        ├── unit/
        ├── integration/
        └── e2e/

build/
├── builders/   # electron-builder configs per OS
├── pipelines/
└── smoke/      # Raspberry Pi smoke scripts
```

**Structure Decision**: Single Electron project (`apps/frame-boy`) med tydlig separation mellan main-process, renderer (Nuxt), core-moduler och delad domänlogik. Detta stödjer modulär expansion, testbarhet och möjliggör separata bundlar för SBC vs desktop.

## Phase 0: Outline & Research
1. **Unknowns & Research Tasks**  
   - Electron + Nuxt 3 integration i en monorepo-struktur (dev server, preload-säkerhet, route-hantering).  
   - Säker nyckelhantering för `electron-store` (OS keychain per plattform, fallback för Pi).  
   - Modul- och widgetladdning (dynamic import, sandboxing, versionering).  
   - Bakgrundsjobb-schemaläggning med minsta intervall 1 minut och isolering från UI-tråd.  
   - Byggkedja för macOS, Windows, Raspberry Pi (electron-builder targets, armv7/arm64).  
   - SBC-prestandaoptimeringar (bundle size, GPU-acceleration, väderdata caches).  

2. **Research Agents**  
   - "Research Electron + Nuxt 3 integration patterns för modulär dashboard"  
   - "Research secure storage för electron-store på macOS/Windows/Linux/Raspberry Pi"  
   - "Find best practices för dynamiska widget-moduler i Electron"  
   - "Research cross-platform builds (electron-builder) med Raspberry Pi armv7/arm64"  
   - "Research SBC performance tuning för always-on touch UI"  

3. **Output**: `research.md` (beslut, motivering, alternativ).  

✅ Phase 0: Research complete (/plan command)

## Phase 1: Design & Contracts
1. **Data Model Extraction** – `data-model.md` (se särskilt sektionerna ModuleManifest, ViewLayout, BackgroundJob, AutoUpdateStatus) beskriver strukturer som Implementation följer.  
2. **Contracts** – Skapa Markdown-kontrakt (TypeScript interface snippets) i `contracts/` för:  
   - Modulmanifest (`contracts/module-manifest.md`).  
   - Widget-registrering + layoutpayload (`contracts/widget-registration.md`).  
   - Bakgrundsjobb (`contracts/background-job.md`).  
   - Auto-update policy (`contracts/auto-update.md`) som definierar GitHub release check API.  
   Dokumentera i respektive kontrakt hur moduler/huvudapp anropas så implementatörer kan länka direkt.  
3. **Tests** – Identifiera initiala röda tester:  
   - Main-process: modulmanifestvalidering, säker kryptering och auto-update scheduler (referens: `contracts/auto-update.md`).  
   - Renderer: grid-layout drag/resize, settings modal, widget rendering pipeline (referens: `data-model.md` → WidgetLayout).  
   - Playwright: helskärmsväxling via huvudmeny, inställningsläge drag-n-drop, Pi smoke run, auto-update prompt (simulerad release).  
4. **Quickstart** – `quickstart.md` med krav (Node 20, pnpm), startkommandon, testflöden, Pi deploy flow.  
5. **Auto-Update Flow** – Dokumentera i `research.md` (Auto-Update Strategy) hur electron-updater konfigureras mot GitHub Releases med hourly polling och silent download + apply, samt länka till `contracts/auto-update.md`.
6. **Agent Context** – uppdaterad via `.specify/scripts/bash/update-agent-context.sh codex` efter plan-dokument färdigställts.  

✅ Phase 1: Design complete (/plan command)

## Phase 2: Task Planning Approach
- `/tasks` kommer att skapa ~28 uppgifter.  
- Kategorier: setup (Electron + Nuxt scaffolding), secure storage, auto-update service, modul core-packages, layout UI, background scheduler, CI + builder, tests (Vitest, Playwright, SBC smoke).  
  - Auto-update service ska följa `contracts/auto-update.md` och uppdatera modellerna i `data-model.md` (§AutoUpdateStatus).  
  - Layout/UI-uppgifter hänvisar till `data-model.md` (§ViewLayout, WidgetDefinition) och `contracts/widget-registration.md`.  
  - Background scheduler följer `contracts/background-job.md` och instrumenteras enligt `research.md` (Background Job Scheduler).  
- Ordering: TDD – kontraktstester → modulmanifester → auto-update scheduler → layoutmodell → renderer UI → background scheduler → encryption service → packaging pipelines → documentation.  
- Mark [P] för oberoende filer (t.ex. separata core-moduler).  
- Output kommer inkludera Raspberry Pi smoke test-körning och auto-update release-simulering innan release.

✅ Phase 2: Task planning complete (/plan command - describe approach only)

## Phase 3+: Future Implementation
- Phase 3: `/tasks` genererar tasks.md (efter denna plan).  
- Phase 4: Implementation enligt tasks, modul-API, UI, tests.  
- Phase 5: Validering – kör Vitest, Playwright, Pi smoke script, bygg releaser.

## Complexity Tracking
| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| *None* | – | Modulär struktur och Electron+Nuxt följer konstitutionen |

## Progress Tracking
**Phase Status**:
- [x] Phase 0: Research complete (/plan command)
- [x] Phase 1: Design complete (/plan command)
- [x] Phase 2: Task planning complete (/plan command - describe approach only)
- [ ] Phase 3: Tasks generated (/tasks command)
- [ ] Phase 4: Implementation complete
- [ ] Phase 5: Validation passed

**Gate Status**:
- [x] Initial Constitution Check: PASS
- [x] Post-Design Constitution Check: PASS
- [x] All NEEDS CLARIFICATION resolved
- [x] Complexity deviations documented

---
*Based on Constitution v1.0.0 - See `/memory/constitution.md`*
